---
title: "Inference in Bartik Designs"
author: "Michal KolesÃ¡r"
date: "`r Sys.Date()`"

bibliography: bartik_library.bib
output:
  pdf_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Inference in Bartik Designs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, cache=FALSE}
library("knitr")
knitr::opts_knit$set(self.contained = FALSE)
knitr::opts_chunk$set(tidy = TRUE, collapse=TRUE, comment = "#>",
                      tidy.opts=list(blank=FALSE, width.cutoff=55))
```

The package `BartikSE` implements confidence intervals proposed by @akm18 for
@bartik91 style regressions. In the future, this file will illustrate the use of
this package. For now, we will just try to replicate Rodrigo's results for our
[@adh13, ADH hereafter] application.

The package contains the following data: list `ADH` that contains the
outcome and control variables, `ADH$sec` that is a vector of sectoral shocks that
we reconstructed, and `ADH$W`, the matrix of sectoral weights.

The correlation with the IV in ADH is quite high:
```{r}
library("BartikSE")
## Aggregate sectoral shocks
ADH$reg$X <- ADH$W %*% ADH$sec$X

cor(ADH$reg$X, ADH$reg$IV)
```

Strangely, there is almost a deterministic relationship between `IV` and `X`:

```{r fig.width=4.5, fig.height=3.5, fig.cap="ADH IV variable reconstruction"}
## See Figure 1 below for output
ggplot2::qplot(ADH$reg$X, ADH$reg$IV)+ggplot2::geom_abline(slope=1, intercept=0)+ggplot2::theme_bw()+
    ggplot2::labs(x="Our reconstruction", y="IV variable in ADH")
```



# Regressions

We now run the first-stage and reduced-form regressions and compute various
standard errors (I haven't coded up clustering of sectors yet):

```{r}
## definte vector of controls
ctrls <- "t2 + l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn +
          l_sh_empl_f + l_sh_routine33 + l_task_outsource + division"
## First stage
b1 <- lmBartik(as.formula(paste("shock ~ ", ctrls)), W=ADH$W, Xs=ADH$sec$X,
                data=ADH$reg, weights=weights, region_cvar=statefip, method="all")
b2 <- lmBartik(as.formula(paste("shock ~ ", ctrls)), W=ADH$W, Xs=ADH$sec$X,
                data=ADH$reg, method="all", region_cvar=statefip)
## Reduced form
b3 <- lmBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls)), W=ADH$W,
               Xs=ADH$sec$X, data=ADH$reg, region_cvar=statefip,
               weights=weights,
               method="all")
b4 <- lmBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls)), W=ADH$W,
               Xs=ADH$sec$X, data=ADH$reg, region_cvar=statefip, method="all")

## IV
b5 <- ivBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls, "| shock")), W=ADH$W,
                Xs=ADH$sec$X, data=ADH$reg, region_cvar=statefip,
                weights=weights, method="all")
b6 <- ivBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls, "| shock")), W=ADH$W,
                Xs=ADH$sec$X, data=ADH$reg, region_cvar=statefip, method="all")
```

IV, first stage and reduced form for weighted regressions:
```{r}
b5 ## IV
b3 ## Reduced form
b1 ## First stage
```

This replicates exactly Rodrigo's results:

1. RF and FS standard errors match exactly for EHW, regional clustering, and
   AKM. For AKM0, I match up to first two significant digits, likely because I
   compute the CI exactly, while Rodrigo does it numerically
2. IV standard errors for AKM match exactly. EHW and cluster don't exactly
   match, probably because I don't use finite-sample corrections, in order to
   match stata, which doesn't use them in IV---see [https://stats.stackexchange.com/questions/329851/default-variance-estimators-in-stata-for-ivregress](https://stats.stackexchange.com/questions/329851/default-variance-estimators-in-stata-for-ivregress).
   For AKM0 I again don't match it exactly (apart from matching the p-value),
   probably due to the numerical inversion issue.
3. The IV standard errors for AKM and AKM0 are still a bit larger than
   EHW/cluster (the "standard error" for AKM0 is just the CI length divided by
   $2z_{0.975}$)



First stage and reduced form for unweighted regressions:
```{r}
b6 ## IV
b4 ## Reduced form
b2 ## First stage
```

Notice that the first-stage error is way smaller for AKM. This must be a
consequence of the fact that we're essentially running a sectoral regression.
Nonetheless, the IV standard error for AKM0 is substantially bigger.

# References
